<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Visual Flow Calc - Professional</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-512.png">
    <meta name="theme-color" content="#2b2d42">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: "Hiragino Maru Gothic ProN", "Yu Gothic", sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --bg-main: #2b2d42;
            --process-text: #edf2f4;
            --latest-text: #f2cc8f;
            --result-text: #f4f1de;
            --btn-num: #3d405b;
            --btn-op: #81b29a;
            --btn-action: #e07a5f;
            --btn-equal: #f2cc8f;
            --btn-ans: #9db4c0;
        }

        body {
            background-color: var(--bg-main);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            width: 100%;
            max-width: 500px;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .display-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 10px 15px;
            min-height: 0;
        }

        .process-columns {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            align-items: end; 
            overflow: hidden;
        }

        .column-box {
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            gap: 4px;
            height: 100%;
            overflow-y: auto;
            border-left: 1px solid rgba(255,255,255,0.05);
            padding: 0 4px;
        }

        .column-box:last-child { border-left: none; }
        .column-box::-webkit-scrollbar { width: 0; }

        .process-item {
            text-align: right;
            color: var(--process-text);
            font-weight: bold;
            white-space: nowrap;
            opacity: 0.6;
            transition: all 0.2s ease;
        }

        .process-item.latest {
            color: var(--latest-text);
            opacity: 1;
            text-shadow: 0 0 8px rgba(242, 204, 143, 0.3);
        }

        .result-container {
            border-top: 2px solid rgba(255,255,255,0.1);
            padding: 10px;
            text-align: right;
            margin-top: 5px;
            min-height: 90px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }

        #main-result {
            color: var(--result-text);
            font-size: 4rem;
            font-weight: bold;
            line-height: 1;
            white-space: nowrap;
            transition: font-size 0.1s;
        }

        .keyboard-section {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            height: 55vh;
            border-top-left-radius: 30px;
            border-top-right-radius: 30px;
        }

        button {
            border: none;
            border-radius: 18px;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.05s;
        }

        button:active { transform: scale(0.92); filter: brightness(1.2); }

        .btn-num { background-color: var(--btn-num); color: var(--result-text); }
        .btn-op { background-color: var(--btn-op); color: var(--bg-main); font-size: 2.5rem; }
        .btn-action { background-color: var(--btn-action); color: white; font-size: 1.4rem; }
        .btn-equal { background-color: var(--btn-equal); color: var(--bg-main); }
        .btn-ans { background-color: var(--btn-ans); color: var(--bg-main); font-size: 1.1rem; }

        @media (max-width: 360px) {
            button { font-size: 1.6rem; }
            .btn-op { font-size: 2rem; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="display-area">
        <div class="process-columns">
            <div id="col-left" class="column-box"></div>
            <div id="col-center" class="column-box"></div>
            <div id="col-right" class="column-box"></div>
        </div>
        <div class="result-container">
            <div id="main-result">0</div>
        </div>
    </div>

    <div class="keyboard-section">
        <button class="btn-action" onclick="clearAll()">AC</button>
        <button class="btn-action" onclick="del()">DEL</button>
        <button class="btn-ans" onclick="manualCarryOver()">引き継ぎ</button>
        <button class="btn-op" onclick="setOp('/')">÷</button>

        <button class="btn-num" onclick="num('7')">7</button>
        <button class="btn-num" onclick="num('8')">8</button>
        <button class="btn-num" onclick="num('9')">9</button>
        <button class="btn-op" onclick="setOp('*')">×</button>

        <button class="btn-num" onclick="num('4')">4</button>
        <button class="btn-num" onclick="num('5')">5</button>
        <button class="btn-num" onclick="num('6')">6</button>
        <button class="btn-op" onclick="setOp('-')">−</button>

        <button class="btn-num" onclick="num('1')">1</button>
        <button class="btn-num" onclick="num('2')">2</button>
        <button class="btn-num" onclick="num('3')">3</button>
        <button class="btn-op" onclick="setOp('+')">+</button>

        <button class="btn-num" onclick="num('0')">0</button>
        <button class="btn-num" onclick="num('.')">.</button>
        <button class="btn-op" onclick="percent()">%</button>
        <button class="btn-equal" onclick="calc()">=</button>
    </div>
</div>

<script>
    let currentInput = '0';
    let stack = [];
    let isCalculated = false;
    let nextOp = "";

    const mainDisplay = document.getElementById('main-result');
    const cols = [
        document.getElementById('col-right'),
        document.getElementById('col-center'),
        document.getElementById('col-left')
    ];

    // 数値をカンマ区切り形式に変換する（小数バグを修正）
    function formatNumber(numStr) {
        if (!numStr || numStr === 'Error' || numStr === '-' || numStr === '.') return numStr;
        
        // 浮動小数点数として正しく解釈できるか確認
        const n = parseFloat(numStr);
        if (isNaN(n)) return numStr;

        const parts = numStr.split('.');
        // 整数部分のカンマ区切り
        const integerPart = parts[0] === "" ? "0" : parts[0];
        const formattedInt = parseInt(integerPart).toLocaleString('en-US');
        
        // 小数部分があれば結合（入力中の「0.」なども保持）
        return parts.length > 1 ? `${formattedInt}.${parts[1]}` : formattedInt;
    }

    function adjustResultFontSize() {
        const length = mainDisplay.innerText.length;
        let size = 4;
        if (length > 15) size = 1.5;
        else if (length > 12) size = 2.0;
        else if (length > 9) size = 2.8;
        else if (length > 7) size = 3.5;
        mainDisplay.style.fontSize = `${size}rem`;
    }

    function updateDisplay() {
        mainDisplay.innerText = formatNumber(currentInput);
        adjustResultFontSize();

        cols.forEach(c => c.innerHTML = '');
        const totalItems = stack.length;
        const itemsPerCol = Math.max(5, Math.ceil(totalItems / 3));

        let fontSize = 1.8;
        if (totalItems > 15) {
            fontSize = Math.max(0.8, 1.8 - (totalItems - 15) * 0.05);
        }

        const reversedStack = [...stack].reverse();
        reversedStack.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = index === 0 ? 'process-item latest' : 'process-item';
            div.style.fontSize = `${fontSize}rem`;
            
            const parts = item.split(' ');
            if (parts.length === 2) {
                div.innerText = `${parts[0]} ${formatNumber(parts[1])}`;
            } else {
                div.innerText = formatNumber(parts[0]);
            }

            const colIndex = Math.floor(index / itemsPerCol);
            if (cols[colIndex]) cols[colIndex].prepend(div);
            else cols[2].prepend(div);
        });

        cols.forEach(c => c.scrollTop = c.scrollHeight);
    }

    function num(n) {
        if (isCalculated) {
            currentInput = n;
            stack = [];
            isCalculated = false;
        } else if (currentInput === '0' && n !== '.') {
            currentInput = n;
        } else {
            if (n === '.' && currentInput.includes('.')) return;
            if (currentInput.replace(/\./g, '').length < 16) {
                currentInput += n;
            }
        }
        updateDisplay();
    }

    function manualCarryOver() {
        if (!isCalculated || mainDisplay.innerText === 'Error') return;
        stack = [];
        updateDisplay();
    }

    function setOp(op) {
        if (mainDisplay.innerText === 'Error') return;

        const visualOp = op === '*' ? '×' : op === '/' ? '÷' : (op === '-' ? '−' : op);
        
        if (isCalculated) {
            stack = [currentInput];
            isCalculated = false;
            nextOp = visualOp;
            currentInput = '0';
            updateDisplay();
            return;
        }

        if (currentInput === '0' && stack.length > 0) {
            nextOp = visualOp;
            return;
        }

        if (stack.length === 0) {
            stack.push(currentInput);
        } else {
            stack.push(nextOp + " " + currentInput);
        }

        nextOp = visualOp;
        currentInput = '0';
        updateDisplay();
    }

    function percent() {
        if (mainDisplay.innerText === 'Error') return;
        let val = parseFloat(currentInput);
        if (isNaN(val)) return;

        if (stack.length > 0) {
            let base = parseFloat(stack[0].replace(/,/g, ''));
            if (nextOp === '+' || nextOp === '−') {
                currentInput = (base * (val / 100)).toString();
            } else {
                currentInput = (val / 100).toString();
            }
        } else {
            currentInput = (val / 100).toString();
        }
        updateDisplay();
    }

    function calc() {
        if (mainDisplay.innerText === 'Error' || isCalculated || (stack.length === 0 && nextOp === "")) return;
        
        let tempStack = [...stack];
        if (nextOp !== "" && currentInput !== '0') {
            tempStack.push(nextOp + " " + currentInput);
        } else if (tempStack.length === 0) {
            return;
        }

        try {
            // カンマを除去してから計算式を組み立て
            const calcExp = tempStack.join(' ')
                .replace(/,/g, '')
                .replace(/×/g, '*')
                .replace(/÷/g, '/')
                .replace(/−/g, '-');
            
            const result = eval(calcExp);
            if (isNaN(result) || !isFinite(result)) throw new Error();

            stack = tempStack;
            // 精度を保ちつつ文字列に変換
            currentInput = parseFloat(result.toPrecision(12)).toString();
            isCalculated = true;
            nextOp = "";
            updateDisplay();
        } catch(e) {
            mainDisplay.innerText = "Error";
        }
    }

    function clearAll() {
        currentInput = '0'; stack = []; nextOp = ""; isCalculated = false;
        updateDisplay();
    }

    function del() {
        if (mainDisplay.innerText === 'Error' || isCalculated) return;
        currentInput = currentInput.length > 1 ? currentInput.slice(0, -1) : '0';
        updateDisplay();
    }

    // PWA Service Worker
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js').catch(() => {});
        });
    }
</script>
</body>
</html>
